pipeline {
    agent any
    environment {
        // Define the path dynamically using $project Ansible variable
        INVENTORY_PATH = "${env.WORKSPACE}/inventory"
    }
    parameters {
        // Dynamically create a choice parameter by listing all files in the inventory folder
        choice(name: 'INVENTORY_FILE', choices: getInventoryFiles(), description: 'Select inventory file')
        choice(name: 'MODE', choices: ['Run Python Script', 'Run Ansible Playbook', 'Echo HelloWorld'], description: 'Select the mode to run')
    }
    stages {
        stage('Run Task Based on Mode') {
            steps {
                script {
                    if (params.MODE == 'Run Python Script') {
                        echo "Running Python Script"
                        sh 'python3 /path/to/your/python_script.py'
                    } else if (params.MODE == 'Run Ansible Playbook') {
                        echo "Running Ansible Playbook with inventory: ${params.INVENTORY_FILE}"
                        // Run the ansible-playbook command with the dynamic project variable
                        sh "ansible-playbook /path/to/your/ansible/playbook.yml -i ${INVENTORY_PATH}/${params.INVENTORY_FILE}"
                    } else if (params.MODE == 'Echo HelloWorld') {
                        echo "HelloWorld"
                    }
                }
            }
        }
    }
}

// Helper function to get all inventory files from the dynamically referenced inventory folder
def getInventoryFiles() {
    def inventoryFiles = []
    def files = new File("${env.WORKSPACE}/inventory").listFiles()
    files.each { file ->
        if (file.isFile()) {
            inventoryFiles << file.getName()
        }
    }
    return inventoryFiles.join('\n')
}
